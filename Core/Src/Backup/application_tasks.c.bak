#include "application_tasks.h"
#include "helper_functions.h"
#include "NMEA.h"
#include "uartRingBuffer.h"
#include <stdlib.h>
#include <math.h>
#include "CLCD_interface.h"
#include "CAR_CTRL_interface.h"

extern volatile uint16_t Global_u16SlitCount;
extern xSemaphoreHandle send_message_semaphore;
extern xSemaphoreHandle receive_message_semaphore;
extern TaskHandle_t send_message_task_handle;
extern uint8_t tx_buffer[32];
extern uint8_t rx_buffer[32];

extern GPSSTRUCT GGAST;
extern ring_buffer *_rx_buffer;

extern char second_car_latitude[11];
extern char second_car_longitude[11];
extern char second_car_direction[8];

extern double my_car_latitude;
extern double my_car_longitude;
extern char north_south;
extern char east_west;
extern double car_direction;

extern uint8_t Upper_Left[8];
extern uint8_t Upper_Right[8];
extern uint8_t Lower_Left[8];
extern uint8_t Lower_Right[8];
extern uint8_t Lower_Mid[8];
extern uint8_t Upper_Mid[8];

void Task_sendMessage(void *parameters) {
	xSemaphoreTake(send_message_semaphore, 0);
	vTaskSuspend(NULL);
	while (1) {
		//Construct the message
		taskENTER_CRITICAL();
		Build_Msg((char*) tx_buffer, my_car_latitude, my_car_longitude,
				north_south, east_west, car_direction);
		taskEXIT_CRITICAL();

		HAL_UART_Transmit_DMA(&huart1, tx_buffer, 32);
		__HAL_DMA_DISABLE_IT(&hdma_usart1_rx, DMA_IT_HT);
		vTaskSuspend(NULL);
		xSemaphoreTake(send_message_semaphore, portMAX_DELAY);
	}
}

void Task_handleReceivedMessage(void *parameters) {
	//Receive the message
	unsigned int i, j;
	double message_latitude, message_longitude, message_direction;
	double distance_calculation, bearing_difference;
	xSemaphoreTake(receive_message_semaphore, 0);
	while (1) {
		xSemaphoreTake(receive_message_semaphore, portMAX_DELAY);
		//rx_buffer contains message
		//Extract up to N for latitude, up to E for longitude
		i = 1, j = 0;
		while (i < 30 && rx_buffer[i] != 'N' && rx_buffer[i] != 'S' && j < 11) {
			second_car_latitude[j] = rx_buffer[i];
			i++;
			j++;
		}
		second_car_latitude[j] = '\0';
		i++;         //no need for NS
		j = 0;

		while (i < 30 && rx_buffer[i] != 'E' && rx_buffer[i] != 'W' && j < 11) {
			second_car_longitude[j] = rx_buffer[i];
			i++;
			j++;
		}
		second_car_longitude[j] = '\0';
		i++;          //no need for EW
		j = 0;

		while (i < 30 && rx_buffer[i] != '#' && j < 8) {
			second_car_direction[j] = rx_buffer[i];
			i++;
			j++;
		}
		second_car_direction[j] = '\0';

		message_latitude = atof(second_car_latitude);
		message_longitude = atof(second_car_longitude);
		message_direction = atof(second_car_direction);

		//bearing_difference
		bearing_difference = fabs(message_direction - car_direction);

		if (bearing_difference < 45 || bearing_difference > 135) {
			//moving in same direction
			if (bearing_difference > 170 || bearing_difference < 10) {
				//same line
				distance_calculation = distance(my_car_latitude,
						my_car_longitude, message_latitude, message_longitude);
				//based on the distance_calculation decide on displaying the warning
				if (distance_calculation < 20) {
					//Display warning
					CLCD_voidDisplayClear();

					CLCD_voidWriteSpeacialChar(Upper_Left, 0, 0, 13);
					CLCD_voidWriteSpeacialChar(Upper_Mid, 1, 0, 14);
					CLCD_voidWriteSpeacialChar(Upper_Right, 2, 0, 15);

					CLCD_voidWriteSpeacialChar(Lower_Left, 3, 1, 13);
					CLCD_voidWriteSpeacialChar(Lower_Mid, 4, 1, 14);
					CLCD_voidWriteSpeacialChar(Lower_Right, 5, 1, 15);

					CLCD_voidGoToXY(0, 0);

					CLCD_voidSendString("Warning: Car");

					CLCD_voidGoToXY(1, 2);

					CLCD_voidSendString("In Front");

				}
			}
		}

		HAL_UART_Receive_DMA(&huart1, rx_buffer, 32);
		__HAL_DMA_DISABLE_IT(&hdma_usart1_rx, DMA_IT_HT);
	}
}

void Task_speedCalculation(void *parameters) {

	static uint16_t Global_u16PreviousSpeed = 0;
	int16_t Local_u16DifferSpeed = 0;
	uint16_t Local_u16CurrentSpeed = 0;

	HAL_NVIC_EnableIRQ(EXTI0_IRQn);

	vTaskDelay(500 / portTICK_RATE_MS);

	while (1) {

		HAL_NVIC_DisableIRQ(EXTI0_IRQn);

		Local_u16CurrentSpeed = (1.6328 / 2) * Global_u16SlitCount;
		Local_u16DifferSpeed = Local_u16CurrentSpeed - Global_u16PreviousSpeed;

		if (Local_u16DifferSpeed <= SS_VELOCITY_THRESHOLD) {
			//Transmit UART Message using DMA
			taskENTER_CRITICAL();
			vTaskResume(send_message_task_handle);
			taskEXIT_CRITICAL();
		}
		Global_u16PreviousSpeed = Local_u16CurrentSpeed;
		Global_u16SlitCount = 0;

		taskENTER_CRITICAL();
		HAL_NVIC_EnableIRQ(EXTI0_IRQn);
		taskEXIT_CRITICAL();
		vTaskDelay(500 / portTICK_RATE_MS);
	}
}

void Task_readingGPS(void *parameters) {
	int flagGGA = 1;
	char c1;
	char GGA[100];
	//char count = 0;
	//double latitude_sum = 0.0;
	//double longitude_sum = 0.0;

	char GGA_loop_index = 0;
	while (1) {
		flagGGA = 1;
		//count = 0;
		//latitude_sum = 0.0;
		//longitude_sum = 0.0;

		//char uartBuflong[100] ={0};
		//char uartBuflat[100] ={0};
		do {
			for (GGA_loop_index = 0; GGA_loop_index < 100; GGA_loop_index++) {
				GGA[(int) GGA_loop_index] = 0;
			}
			// extracting the message ($gga)
			//HAL_UART_Transmit(&huart6,(uint8_t *)"extracting the message", 23, 100);

			//MCAL_UART_u8ReceiveData(UART_3, (uint8_t *)&c);
			HAL_UART_Receive(&huart6, (uint8_t*) &c1, sizeof(c1), 1000);
			// start with the dollar sign if not then loop to find it
			for (int k = 0; c1 != '$'; k++) {
				// MCAL_UART_u8ReceiveData(UART_3, (uint8_t *)&c);
				HAL_UART_Receive(&huart6, (uint8_t*) &c1, sizeof(c1), 1000);
			}

			store_char(c1, _rx_buffer);
			//MCAL_UART_u8ReceiveData(UART_3,(uint8_t *) &c);
			HAL_UART_Receive(&huart6, (uint8_t*) &c1, sizeof(c1), 1000);
			// loop to store all the frame after dollar until next dollar recieved
			while (c1 != '$') {
				store_char(c1, _rx_buffer);
				//MCAL_UART_u8ReceiveData(UART_3,(uint8_t *) &c);
				HAL_UART_Receive(&huart6, (uint8_t*) &c1, sizeof(c1), 1000);
			}

			// once the new dollar received the old frame is now in the buffer to be decoded
			// end of extracting

			// HAL_UART_Transmit(&huart6,(uint8_t *)"\r\n", 2, 100);
			// HAL_UART_Transmit(&huart6,(uint8_t *) "Before enter do while ", 23, 100);
			//  HAL_UART_Transmit(&huart6,(uint8_t *)"\r\n", 2, 100);
			//HAL_UART_Transmit(&huart6,(uint8_t *)"\r\n", 2, 100);
			//HAL_UART_Transmit(&huart6,(uint8_t *) "inside do while ", 17, 100);
			flagGGA = 1;

			if (Wait_for("GGA") == 1) {
				// HAL_UART_Transmit(&huart6,(uint8_t *) "found gga ", 11, 100);
				//HAL_UART_Transmit(&huart6,(uint8_t *)"\r\n", 2, 100);
				//HAL_UART_Transmit(&huart6,(uint8_t *) "outside wait ", 13, 100);
				Copy_upto("*", GGA);
				if (decodeGGA(GGA, &GGAST.ggastruct) == 0) {
					//latitude_sum += GGAST.ggastruct.lcation.latitude;
					//longitude_sum += GGAST.ggastruct.lcation.longitude;
					//count++;
					//if (count == 1) {
					flagGGA = 0;
					//count = 0;
					//}
				}
			}

		} while (flagGGA == 1);

		// in using freertos
		// here is the delay ------
		taskENTER_CRITICAL();
		my_car_latitude = GGAST.ggastruct.lcation.latitude;	//latitude_sum ;/// 2;//* 100;
		my_car_longitude = GGAST.ggastruct.lcation.longitude;//longitude_sum;// / 2; //* 100;
		north_south = GGAST.ggastruct.lcation.NS;
		east_west = GGAST.ggastruct.lcation.EW;
		taskEXIT_CRITICAL();

		vTaskDelay(100 / portTICK_RATE_MS);

		// here for just showing data using uart3
		// HAL_UART_Transmit(&huart6,(uint8_t *)"\r\n", 2, 100);
		//  HAL_UART_Transmit(&huart6,(uint8_t *) "outside do while ", 18, 100);
		// HAL_UART_Transmit(&huart6,(uint8_t *)"\r\n", 2, 100);
		// ftoa(GGAST.ggastruct.lcation.longitude ,uartBuflong,6);
		//  ftoa(GGAST.ggastruct.lcation.latitude ,uartBuflat,6);
		//HAL_UART_Transmit(&huart6,(uint8_t *) "Longitude is : ", 16, 100);
		//HAL_UART_Transmit(&huart6, (uint8_t *)uartBuflong, sizeof(uartBuflong), 100);
		// HAL_UART_Transmit(&huart6, (uint8_t *)&(GGAST.ggastruct.lcation.EW), sizeof(GGAST.ggastruct.lcation.EW), 100);
		//HAL_UART_Transmit(&huart6,(uint8_t *)"\r\n", 2, 100);
		// HAL_UART_Transmit(&huart6, (uint8_t *)"Latitude is : ", 15, 100);
		// HAL_UART_Transmit(&huart6, (uint8_t *)uartBuflat, sizeof(uartBuflat), 100);
		// HAL_UART_Transmit(&huart6, (uint8_t *)&(GGAST.ggastruct.lcation.NS), sizeof(GGAST.ggastruct.lcation.NS), 100);

		//  HAL_UART_Transmit(&huart6,(uint8_t *)"\r\n", 2, 100);

		/* USER CODE BEGIN 3 */

	}
}

void Task_directionOfCar(void *parameters) {
	static volatile double car_lat1;
	static volatile double car_lon1;
	static volatile double car_lat2;
	static volatile double car_lon2;
	while (1) {
		//taskENTER_CRITICAL();
		car_lat1 = my_car_latitude;
		car_lon1 = my_car_longitude;
		//taskEXIT_CRITICAL();

		vTaskDelay(5000 / portTICK_RATE_MS);

		//taskENTER_CRITICAL();
		car_lat2 = my_car_latitude;
		car_lon2 = my_car_longitude;
		//taskEXIT_CRITICAL();

		taskENTER_CRITICAL();
		car_direction = bearing(car_lat1, car_lon1, car_lat2, car_lon2);
		taskEXIT_CRITICAL();
	}

}

void Task_controlCar(void *parameters) {
	uint8_t Local_u8Received_data = 0;
	while (1) {
		/* Initialize buffer Variable To Hold Received Char */
		Local_u8Received_data = 0;
		if (HAL_UART_Receive(&huart4, &Local_u8Received_data, 1, 100)
				== HAL_OK) {

			/* Return To The Normal Speed */
			TIM3->CCR1 = 75;
			TIM12->CCR1 = 75;

			/* Direction Change According To The Received Direction */
			if (Local_u8Received_data == 'f')
				HAL_CAR_CTRL_voidForward();
			else if (Local_u8Received_data == 'b')
				HAL_CAR_CTRL_voidBackward();
			else if (Local_u8Received_data == 'l')
				HAL_CAR_CTRL_voidRight();
			else if (Local_u8Received_data == 'r')
				HAL_CAR_CTRL_voidLeft();
			else if (Local_u8Received_data == 's') {
				HAL_CAR_CTRL_voidStop();
				CLCD_voidDisplayClear();
			}

		} else {
			/* Decrease The Speed Gradually */
			if ((TIM3->CCR1) >= 10) {
				TIM3->CCR1 -= 1;
				TIM12->CCR1 -= 1;

				//pwm.CCR1 -= 10;
			}
			/* Stop The RC Car */
			else {
				TIM3->CCR1 = 0;
				TIM12->CCR1 = 0;
				//pwm.CCR1 = 0;
			}
		}

	}
}
